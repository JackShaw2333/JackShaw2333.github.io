---
title: 红黑树
date: 2020-09-27 15:14:42
tags:
---

## 红黑树

红黑树（red-black tree）是一颗二叉搜索树，它的每个结点有一个存储位标识节点的颜色，可以是`RED`或`BLACK`。红黑树确保没有一条路径会比其他路径长出2倍，因而近似是平衡的。

<!--more-->

一颗红黑树是满足以下红黑性质的二叉搜索树：

1. <span id="property-1">每个结点非黑即红</span>
2. <span id="property-2">根节点是黑色的</span>
3. <span id="property-3">每个叶节点是（NIL）黑色的</span>
4. <span id="property-4">如果1个结点是<font color="red">红</font>色的，则它的2个子结点都是黑色的</span>
5. <span id="property-5">对每个结点，从该结点到其所有后代叶结点的简单路径上，均包含相同数目的黑色结点</span>

从最后1个性质可以推出，黑色结点一定有2个子结点。

红黑树并非完美的平衡二叉树，它的平衡条件不如AVL树严格，因此根据同一组数据构造出的红黑树的高度相比AVL树会更高。

但是根据最后一个性质可以得出，红黑树左右子树的黑结点层数是相同的，这称为黑色完美平衡。

## 红黑树的相关操作

### 平衡操作

红黑树的平衡依靠的是3种操作：

- 左旋：以某个结点为旋转结点，其右子结点变为旋转结点的的父结点，右子结点的左子结点变为旋转结点的右子结点。
- 右旋：以某个结点为旋转结点，其左子结点变为旋转结点的的父结点，左子结点的右子结点变为旋转结点的左子结点。
- 变色

```graph
  P                      V
 / \       对P左旋      / \
F   V    ---------->   P   X
   / \                / \
  R   X              F   R
```

```graph
    P                    F
   / \     对P右旋      / \
  F   V  ---------->   D   P
 / \                      / \
D   K                    K   V
```

由上述图示可以看出旋转操作不会影响旋转结点的父结点及以上的结构。

**左旋**影响旋转结点和其**右子树**的结构；

**右旋**影响旋转结点和其**左子树**的结构。

### 插入

插入操作可分为2步：

- 查找插入位置
- 插入后自平衡

插入操作有4种情景需要考虑：

1. 红黑树为空树
2. 插入结点的key已存在
3. 插入结点的父结点为黑结点
4. 插入结点的父结点为<font color="red">红</font>结点
   1. 叔叔结点存在并为<font color="red">红</font>结点
   2. 叔叔结点不存在，且插入结点的父结点是祖父结点的**左子结点**
      1. 插入节点是其父结点的**左子结点**
      2. 插入节点是其父结点的**右子结点**
   3. 叔叔结点不存在，且插入结点的父结点是祖父结点的**右子结点**
      1. 插入节点是其父结点的**左子结点**
      2. 插入节点是其父结点的**右子结点**

一共有8种情景需要考虑，但其实情景1，2，3的处理其实很简单，而情景4.2和情景4.3只是方向反转，所以总体而言并不复杂。

#### 情景1 红黑树为空树

此时直接将插入节点作为树根即可。不要忘记根据[红黑树性质2](#property-2)将根节点置黑色。

#### 情景2 插入节点的key已存在

此时只需更新已存在的这个结点的值即可。

#### 情景3 插入结点的父结点为黑结点

此时插入的结点为红色即可，不会影响红黑树的平衡。

#### 情景4 插入结点的父结点为<font color="red">红</font>结点

若父结点为<font color="red">红</font>结点，根据[红黑树性质4](#property-4)该插入结点必须为黑节点。

又根据[红黑树性质2：根节点是黑色的](#property-2)，该插入结点的父结点肯定不是根节点，则该插入结点一定存在祖父结点。这是非常重要的一点，后续的旋转操作需要祖父结点的参与。

情景4分为多个子情景

##### 子情景4.1 叔结点存在，为<font color="red">红</font>结点

同样根据[红黑树性质4](#property-4)，祖父结点只能为黑色。那么，树内相关结点的形状就可能如下图左侧所示（后缀r表示红色，后缀b表示黑色，后文同理）。其中`Ir`结点为插入结点，为了保持红黑树的平衡，插入结点都先初始化为红色。

```graph
    PPb                   PPr
   /  \       变色       /  \
  Pr   Sr  ---------->  Pb   Sb
 /                     /
Ir                    Ir
```

此时最简单的方法就是改变**父结点一层和祖父结点**的颜色。

变色后

- 如果祖父结点`PP`的父结点为红色，那么祖父结点需要被当作插入结点，递归向上进行平衡操作直到红黑树平衡
- 如果祖父结点本身是根节点，那么`PP`结点需要重新置黑色，注意此时黑色结点的层数（黑高）增加了

##### 子情景4.2 叔结点不存在，且插入结点的父结点是祖父结点的左子结点

此时若只考虑插入前的红黑树情况（不考虑上一情景中的向上递归），则叔结点必为空结点（Nil），否则父结点子树和叔结点子树的黑高不同，违反[红黑树性质5](#property-5)。

###### 子子情景4.2.1 插入结点为父结点的左子结点

此时树相关结点的形状可能如下图左侧所示。

```graph
    PPb                 Pb
   /     对PP右旋      /  \
  Pr    --------->   Ir   PPr
 /
Ir
```

此时的处理方法是

- 将`P`结点设为黑色，`PP`结点设为红色
- 对`PP`右旋

也可以采取相反的变色操作，`P`变为红色，`I`和`PP`变为黑色，但此时仍需递归向上平衡操作。

###### 子子情景4.2.2 插入结点是其父结点的右子结点

这种情况可以转换为子子情景4.2.1，具体操作如下图所示。

```graph
  PPb               PPb
 /      对P左旋     /
Pr    ---------->  Ir
 \                /
  Ir             Pr
```

对父结点`P`左旋后，就转换为子子情景4.2.1。

##### 子情景4.3 叔结点不存在，且插入结点的父结点是祖父结点的右子结点

该情景与情景4.2对称，直接用图说明操作过程。

###### 子子情景4.3.1 插入节点是其父结点的左子结点

```graph
PPb                PPb
  \     对P右旋      \
  Pr  ---------->    Ir
 /                     \
Ir                      Pr
```

对P右旋后转换为子子情景4.3.2

###### 子子情景4.3.2 插入节点是其父结点的右子结点

```graph
PPb                     Pb
  \        对PP左旋    /  \
   Pr    ----------> PPr   Ir  
    \
     Ir
```

### 删除

删除操作可分为2步：

- 查找目标结点
- 删除后自平衡

删除结点后的自平衡操作中很重要的一块内容是寻找合适的替代结点。寻找替代结点存在2种情景：

- 若被删除结点无子结点，直接删除
- 若被删除结点有子结点，用后继结点（大于被删除结点的最小结点）替换

大于被删除结点的最小结点也就是被删除结点右子树的最左结点，即中序遍历序列里被删除结点的下一结点。当然也可以用中序遍历序列中被删除结点的前一结点进行替换。一般采用后继结点进行替换。

考虑这样一种思考方式，将被删除结点和替代结点交换后，再删除处于原先替代结点位置的被删除结点。

通过这种思考方式，上述2种情景就可以彼此转换，转换关系如下所示

- 情景1：无需考虑替代结点，直接删除即可
- 情景2：此时被删除结点为后继结点，递归操作

分析以上2种情形可知，最终删除操作都能够转换为情景1的情况，即在叶节点层进行删除操作。

当然，若被删除结点只有1个子结点时，可以简单地使用子结点进行替代，省去寻找后继以及接下来的递归操作。

## 参考资料

- [30张图带你彻底理解红黑树]
- 算法导论（原书第3版）

[30张图带你彻底理解红黑树]: (https://www.jianshu.com/p/e136ec79235c)

<!--<font color="red">红</font>-->